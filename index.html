<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AegisSchool MIS</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script>
        const { useState, useEffect } = React;

        function AegisSchoolMIS() {
            const [users, setUsers] = useState(() => JSON.parse(localStorage.getItem('users')) || []);
            const [current, setCurrent] = useState(() => JSON.parse(localStorage.getItem('current')) || null);
            const [students, setStudents] = useState(() => JSON.parse(localStorage.getItem('students')) || []);
            const [attendance, setAttendance] = useState(() => JSON.parse(localStorage.getItem('attendance')) || {});
            const [behaviourLogs, setBehaviourLogs] = useState(() => JSON.parse(localStorage.getItem('behaviourLogs')) || []);
            const [grades, setGrades] = useState(() => JSON.parse(localStorage.getItem('grades')) || {});
            const [timetable, setTimetable] = useState(() => JSON.parse(localStorage.getItem('timetable')) || {Monday:{P1:'',P2:'',P3:'',P4:'',P5:''}, Tuesday:{P1:'',P2:'',P3:'',P4:'',P5:''}, Wednesday:{P1:'',P2:'',P3:'',P4:'',P5:''}, Thursday:{P1:'',P2:'',P3:'',P4:'',P5:''}, Friday:{P1:'',P2:'',P3:'',P4:'',P5:''}});

            useEffect(() => {
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('current', JSON.stringify(current));
                localStorage.setItem('students', JSON.stringify(students));
                localStorage.setItem('attendance', JSON.stringify(attendance));
                localStorage.setItem('behaviourLogs', JSON.stringify(behaviourLogs));
                localStorage.setItem('grades', JSON.stringify(grades));
                localStorage.setItem('timetable', JSON.stringify(timetable));
            }, [users, current, students, attendance, behaviourLogs, grades, timetable]);

            const signup = (user, pass, role) => {
                if(users.find(u => u.user === user)) {
                    alert('User exists');
                    return;
                }
                setUsers([...users, {user, pass, role}]);
                setCurrent({user, role});
            };

            const login = (user, pass) => {
                const found = users.find(u => u.user === user && u.pass === pass);
                if(!found) {
                    alert('Invalid credentials');
                    return;
                }
                setCurrent({user: found.user, role: found.role});
            };

            const logout = () => {
                setCurrent(null);
            };

            const addStudent = (name) => {
                if(!name.trim()) return;
                setStudents([...students, {id: Date.now(), name, grade: 2, points: 0, detention: false}]);
            };

            const markAttendance = (studentId, status) => {
                const today = new Date().toISOString().split('T')[0];
                const dayRec = attendance[today] || {};
                dayRec[studentId] = status;
                setAttendance({...attendance, [today]: dayRec});
            };

            const addBehaviour = (studentId, score, pointsDelta, note) => {
                const record = {id: Date.now(), studentId, score, pointsDelta, note, time: new Date().toISOString()};
                setBehaviourLogs([record, ...behaviourLogs]);
                setStudents(students.map(s => s.id === studentId ? {...s, points: (s.points || 0) + pointsDelta, detention: score === 2 || score === 4 || ((s.points || 0) + pointsDelta) <= -5} : s));
            };

            const recordGrade = (studentId, subject, grade) => {
                const rec = grades[studentId] || {};
                setGrades({...grades, [studentId]: {...rec, [subject]: grade}});
            };

            const updateLesson = (day, period, value) => {
                setTimetable({...timetable, [day]: {...timetable[day], [period]: value}});
            };

            const announce = (msg) => {
                if(!msg.trim()) return;
                const utter = new SpeechSynthesisUtterance(msg);
                speechSynthesis.speak(utter);
            };

            if(!current) {
                const [loginUser, setLoginUser] = useState('');
                const [loginPass, setLoginPass] = useState('');
                const [signupUser, setSignupUser] = useState('');
                const [signupPass, setSignupPass] = useState('');
                const [signupRole, setSignupRole] = useState('teacher');

                return React.createElement('div', {className: 'min-h-screen bg-gradient-to-br from-blue-600 to-blue-800 flex items-center justify-center p-4'},
                    React.createElement('div', {className: 'bg-white rounded-lg shadow-xl p-8 max-w-md w-full space-y-4'},
                        React.createElement('h1', {className: 'text-3xl font-bold text-blue-600'}, 'AegisSchool MIS'),
                        React.createElement('p', {className: 'text-gray-600 text-sm'}, 'Management Information System'),
                        React.createElement('hr', {}),
                        React.createElement('div', {},
                            React.createElement('label', {className: 'block text-sm font-semibold mb-2'}, 'Login'),
                            React.createElement('input', {value: loginUser, onChange: e => setLoginUser(e.target.value), placeholder: 'Username', className: 'border p-2 w-full rounded mb-2'}),
                            React.createElement('input', {value: loginPass, onChange: e => setLoginPass(e.target.value), type: 'password', placeholder: 'Password', className: 'border p-2 w-full rounded mb-2'}),
                            React.createElement('button', {className: 'bg-blue-600 text-white p-2 w-full rounded hover:bg-blue-700', onClick: () => login(loginUser, loginPass)}, 'Login')
                        ),
                        React.createElement('hr', {}),
                        React.createElement('div', {},
                            React.createElement('label', {className: 'block text-sm font-semibold mb-2'}, 'Create Account'),
                            React.createElement('input', {value: signupUser, onChange: e => setSignupUser(e.target.value), placeholder: 'Username', className: 'border p-2 w-full rounded mb-2'}),
                            React.createElement('input', {value: signupPass, onChange: e => setSignupPass(e.target.value), type: 'password', placeholder: 'Password', className: 'border p-2 w-full rounded mb-2'}),
                            React.createElement('select', {value: signupRole, onChange: e => setSignupRole(e.target.value), className: 'border p-2 w-full rounded mb-2'},
                                React.createElement('option', {value: 'teacher'}, 'Teacher'),
                                React.createElement('option', {value: 'admin'}, 'Admin')
                            ),
                            React.createElement('button', {className: 'bg-green-600 text-white p-2 w-full rounded hover:bg-green-700', onClick: () => signup(signupUser, signupPass, signupRole)}, 'Create Account')
                        )
                    )
                );
            }

            const [activePage, setActivePage] = useState('Dashboard');
            const pages = ['Dashboard', 'Students', 'Attendance', 'Behaviour', 'Timetable', 'Assessment', 'Reports', 'PA'];

            const DashboardPage = () => React.createElement('div', {}, React.createElement('h1', {className: 'text-3xl font-bold'}, 'Welcome to AegisSchool MIS'));

            const StudentsPage = () => {
                const [input, setInput] = useState('');
                return React.createElement('div', {},
                    React.createElement('h2', {className: 'text-xl font-bold mb-4'}, 'Students'),
                    React.createElement('div', {className: 'flex gap-2 mb-4'},
                        React.createElement('input', {value: input, onChange: e => setInput(e.target.value), placeholder: 'Student name', className: 'border p-2 flex-1 rounded'}),
                        React.createElement('button', {onClick: () => {addStudent(input); setInput('');}, className: 'bg-blue-600 text-white px-4 py-2 rounded'}, 'Add')
                    ),
                    React.createElement('ul', {className: 'bg-white p-4 rounded'},
                        students.map(s => React.createElement('li', {key: s.id, className: 'p-2 border-b'}, s.name))
                    )
                );
            };

            const AttendancePage = () => {
                const today = new Date().toISOString().split('T')[0];
                const todayRec = attendance[today] || {};
                return React.createElement('div', {},
                    React.createElement('h2', {className: 'text-xl font-bold mb-4'}, 'Attendance'),
                    students.map(s => React.createElement('div', {key: s.id, className: 'flex gap-2 items-center mb-2 p-2 bg-white rounded'},
                        React.createElement('span', {className: 'flex-1'}, s.name),
                        ['present', 'late', 'absent'].map(status => React.createElement('button', {key: status, onClick: () => markAttendance(s.id, status), className: `px-3 py-1 rounded ${todayRec[s.id] === status ? 'bg-green-500 text-white' : 'bg-gray-200'}`}, status[0].toUpperCase()))
                    ))
                );
            };

            const BehaviourPage = () => {
                const [studentId, setStudentId] = useState('');
                const [score, setScore] = useState(3);
                const [points, setPoints] = useState(0);
                const [note, setNote] = useState('');
                return React.createElement('div', {},
                    React.createElement('h2', {className: 'text-xl font-bold mb-4'}, 'Behaviour'),
                    React.createElement('div', {className: 'bg-white p-4 rounded mb-4 space-y-2'},
                        React.createElement('select', {value: studentId, onChange: e => setStudentId(e.target.value), className: 'border p-2 w-full rounded'},
                            React.createElement('option', {value: ''}, 'Select student'),
                            students.map(s => React.createElement('option', {key: s.id, value: s.id}, s.name))
                        ),
                        React.createElement('select', {value: score, onChange: e => setScore(Number(e.target.value)), className: 'border p-2 w-full rounded'},
                            React.createElement('option', {value: 1}, '1 - Excellent'),
                            React.createElement('option', {value: 2}, '2 - Good'),
                            React.createElement('option', {value: 3}, '3 - Disruptive'),
                            React.createElement('option', {value: 4}, '4 - Poor'),
                            React.createElement('option', {value: 5}, '5 - Unsatisfactory')
                        ),
                        React.createElement('input', {type: 'number', value: points, onChange: e => setPoints(Number(e.target.value)), placeholder: 'Points', className: 'border p-2 w-full rounded'}),
                        React.createElement('input', {value: note, onChange: e => setNote(e.target.value), placeholder: 'Note', className: 'border p-2 w-full rounded'}),
                        React.createElement('button', {onClick: () => {if(studentId) {addBehaviour(Number(studentId), score, points, note); setNote(''); setPoints(0);}}, className: 'bg-blue-600 text-white p-2 w-full rounded'}, 'Record')
                    )
                );
            };

            const TimetablePage = () => {
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
                const periods = ['P1', 'P2', 'P3', 'P4', 'P5'];
                return React.createElement('div', {},
                    React.createElement('h2', {className: 'text-xl font-bold mb-4'}, 'Timetable'),
                    days.map(day => React.createElement('div', {key: day, className: 'mb-4'},
                        React.createElement('h3', {className: 'font-semibold mb-2'}, day),
                        React.createElement('div', {className: 'grid grid-cols-5 gap-2'},
                            periods.map(p => React.createElement('input', {key: p, value: timetable[day][p], onChange: e => updateLesson(day, p, e.target.value), placeholder: p, className: 'border p-2 rounded text-sm'}))
                        )
                    ))
                );
            };

            const AssessmentPage = () => {
                const [studentId, setStudentId] = useState('');
                const [subject, setSubject] = useState('Math');
                const [mark, setMark] = useState('');
                return React.createElement('div', {},
                    React.createElement('h2', {className: 'text-xl font-bold mb-4'}, 'Assessment'),
                    React.createElement('div', {className: 'space-y-2'},
                        React.createElement('select', {value: studentId, onChange: e => setStudentId(e.target.value), className: 'border p-2 w-full rounded'},
                            React.createElement('option', {value: ''}, 'Select student'),
                            students.map(s => React.createElement('option', {key: s.id, value: s.id}, s.name))
                        ),
                        React.createElement('input', {value: subject, onChange: e => setSubject(e.target.value), placeholder: 'Subject', className: 'border p-2 w-full rounded'}),
                        React.createElement('input', {value: mark, onChange: e => setMark(e.target.value), placeholder: 'Mark', className: 'border p-2 w-full rounded'}),
                        React.createElement('button', {onClick: () => {if(studentId) {recordGrade(Number(studentId), subject, mark); setMark('');}}, className: 'bg-green-600 text-white p-2 w-full rounded'}, 'Save')
                    )
                );
            };

            const ReportsPage = () => {
                const exportCSV = (rows, filename) => {
                    const csv = rows.map(r => r.join(',')).join('\n');
                    const blob = new Blob([csv], {type: 'text/csv'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                };
                return React.createElement('div', {},
                    React.createElement('h2', {className: 'text-xl font-bold mb-4'}, 'Reports'),
                    React.createElement('button', {onClick: () => {const rows = [['Date', 'Student', 'Status']]; Object.entries(attendance).forEach(([date, dayRec]) => {students.forEach(s => rows.push([date, s.name, dayRec[s.id] || 'absent']));}); exportCSV(rows, 'attendance.csv');}, className: 'bg-blue-600 text-white p-2 w-full rounded mb-2'}, 'Export Attendance')
                );
            };

            const PAPage = () => {
                const [msg, setMsg] = useState('');
                return React.createElement('div', {},
                    React.createElement('h2', {className: 'text-xl font-bold mb-4'}, 'PA System'),
                    React.createElement('textarea', {value: msg, onChange: e => setMsg(e.target.value), placeholder: 'Announcement', className: 'border p-2 w-full rounded h-32 mb-2'}),
                    React.createElement('button', {onClick: () => {announce(msg); setMsg('');}, className: 'bg-purple-600 text-white p-2 w-full rounded'}, 'Announce')
                );
            };

            const renderPage = () => {
                switch(activePage) {
                    case 'Students': return React.createElement(StudentsPage, {});
                    case 'Attendance': return React.createElement(AttendancePage, {});
                    case 'Behaviour': return React.createElement(BehaviourPage, {});
                    case 'Timetable': return React.createElement(TimetablePage, {});
                    case 'Assessment': return React.createElement(AssessmentPage, {});
                    case 'Reports': return React.createElement(ReportsPage, {});
                    case 'PA': return React.createElement(PAPage, {});
                    default: return React.createElement(DashboardPage, {});
                }
            };

            return React.createElement('div', {className: 'flex'},
                React.createElement('div', {className: 'w-60 bg-blue-700 text-white h-screen p-4 flex flex-col gap-2'},
                    React.createElement('h1', {className: 'text-2xl font-bold mb-4'}, 'AegisSchool'),
                    pages.map(p => React.createElement('button', {key: p, onClick: () => setActivePage(p), className: `p-2 rounded ${activePage === p ? 'bg-blue-900' : 'bg-blue-600 hover:bg-blue-800'}`}, p)),
                    React.createElement('button', {onClick: logout, className: 'mt-auto bg-red-600 p-2 rounded'}, 'Logout')
                ),
                React.createElement('div', {className: 'flex-1 p-6 bg-gray-100 min-h-screen'},
                    renderPage()
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(AegisSchoolMIS, {}));
    </script>
</body>
</html>
